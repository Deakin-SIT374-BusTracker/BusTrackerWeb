@model  IEnumerable<BusTrackerWeb.Models.DepartureModel>

@{ 
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-header">
    <h1><img style="max-width:50px; margin-top: -4px; margin-right: 10px; float:left;" src="~/Content/Images/bushop-logo.png">Your Journey</h1>
</div>

<div>
    <div class="row" style="width: 100%">
        <div class="col-md-6">
            <table id="scheduleTable" class="table table-striped">
                <tr>
                    <th>Bus Stop:</th>
                    <th>Departure Time:</th>
                </tr>
                
                @foreach (var departure in Model)
                {
                    <tr>
                        <td>@Html.DisplayFor(modelItem => departure.Stop.StopName)</td>
                        <td>@Html.DisplayFor(modelItem => departure.ScheduledDeparture)</td>
                    </tr>
                }
            </table>
        </div>
        <div class="col-md-6">
            <div id="map_canvas" style="min-height:40em; width:100%"></div>
        </div>
    </div>
</div>



<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqZFelSFhnk3JDbFVx7qovf8IIG1ZViVs&libraries=geometry"></script>
<script type="text/javascript">
    function initGoogleMap() {
        // Initialise marker coordinates.
        var stopsLatitudeArray = @Html.Raw(Json.Encode(@ViewBag.StopsLatitudeArray));
        var stopsLongitudeArray = @Html.Raw(Json.Encode(@ViewBag.StopsLongitudeArray));
        var encodedPolyline = @Html.Raw(Json.Encode(@ViewBag.EncodePolylines));
        var departures = @Html.Raw(Json.Encode(@ViewBag.Departures));

        // Find the map center marker.
        var centerIndex = Math.round(stopsLatitudeArray.length / 2)
        var centerLocation = new google.maps.LatLng(stopsLatitudeArray[centerIndex], stopsLongitudeArray[centerIndex]);

        // set map options.
        var options = {
            zoom: 14,
            center: centerLocation,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        // Update map with options.
        var map = new google.maps.Map(document.getElementById("map_canvas"), options);


        // Create array of info windows for marker attachment.
        var infowindow = [];

        // Add map markers and set bounds.
        var bounds = new google.maps.LatLngBounds();

        var infowindow = null;
        infowindow = new google.maps.InfoWindow({
            content: "holding..."
        });

        for (var i = 0; i < departures.length; i++) {
            // Create Marker.
            var newlocation = new google.maps.LatLng(departures[i].Stop.StopLatitude, departures[i].Stop.StopLongitude);
            var newMarker = new google.maps.Marker({
                position: newlocation,
                map: map,
                title: departures[i].Stop.StopName,
                html: '<h4>' + departures[i].Stop.StopName + '</h4><p>' + new Date(parseInt(departures[i].ScheduledDeparture.replace('/Date(', ''))) + '</p>',
            });

            // Add Info Window.
            google.maps.event.addListener(newMarker, 'click', function () {
                // where I have added .html to the marker object.
                infowindow.setContent(this.html);
                infowindow.open(map, this);
            });

            // Extend bounds of map based on new marker.
            bounds.extend(newMarker.getPosition());
        }

        map.fitBounds(bounds);

        // Render the polyline returned by the Google Directions API.

        for (var i = 0; i < encodedPolyline.length; i++) {
            var decodedPolyline = google.maps.geometry.encoding.decodePath(encodedPolyline[i]);

            var drivePath = new google.maps.Polyline({
                path: decodedPolyline,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            drivePath.setMap(map);
        }
    }

    initGoogleMap();

</script>
